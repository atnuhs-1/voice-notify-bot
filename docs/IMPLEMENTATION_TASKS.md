# 実装タスクリスト

## 実装フェーズ概要

### Phase 1: データベース拡張・基盤整備（Week 1-2）
- 新規テーブル作成・マイグレーション
- 型定義の追加・更新
- 基本的なCRUD操作実装

### Phase 2: 統計機能バックエンド（Week 3-4）
- 個人入退室記録システム
- 統計計算ロジック
- 新API設計での基本エンドポイント実装

### Phase 3: フロントエンド統計画面（Week 5-6）
- 統計ダッシュボード画面
- ランキング・タイムライン表示
- 手動更新機能

### Phase 4: 通知システム（Week 7-8）
- 通知スケジュール管理
- Discord自動通知機能
- 通知設定Web UI

## Phase 1: データベース拡張・基盤整備

### 1.1 データベーステーブル作成
- [ ] **1.1.1** `user_voice_activities` テーブル作成
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: 個人の入退室ログテーブル追加
  - **制約**: 既存のvoice_sessionsとの外部キー制約
  
- [ ] **1.1.2** `period_user_stats` テーブル作成  
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: 週間・月間・年間統計集計テーブル
  - **制約**: guildId, userId, periodType, periodKey のUNIQUE制約

- [ ] **1.1.3** 通知関連テーブル作成
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: notification_schedules, daily_activity_summaries等
  - **制約**: 重複通知防止のためのUNIQUE制約

- [ ] **1.1.4** インデックス作成
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: パフォーマンス最適化用インデックス
  - **重要**: ランキング取得・タイムライン表示の高速化

### 1.2 TypeScript型定義
- [ ] **1.2.1** データベース型定義追加
  - **ファイル**: `backend/types/database.ts` (新規作成)
  - **内容**: 新テーブル用のTypeScript型定義
  - **連携**: Fastify型拡張との整合性

- [ ] **1.2.2** API型定義追加
  - **ファイル**: `backend/types/api.ts` (新規作成)
  - **内容**: 統一APIレスポンス形式の型定義
  - **重要**: APIResponse<T>, APIError, PermissionLevel等

- [ ] **1.2.3** フロントエンド型定義更新
  - **ファイル**: `frontend/src/types/statistics.ts` (新規作成)
  - **内容**: 統計データ・ランキング・タイムライン用型定義
  - **連携**: バックエンドAPI型との一致

### 1.3 データベースヘルパー拡張
- [ ] **1.3.1** user_voice_activities操作関数
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: createUserActivity, endUserActivity等
  - **連携**: 既存のdbHelpersに追加

- [ ] **1.3.2** period_user_stats操作関数
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: updatePeriodStats, getPeriodRanking等
  - **重要**: リアルタイム統計更新機能

- [ ] **1.3.3** 通知管理操作関数
  - **ファイル**: `backend/plugins/database.ts`
  - **内容**: スケジュール管理・サマリー作成関数
  - **連携**: 通知システムとの連携

## Phase 2: 統計機能バックエンド

### 2.1 Discord イベントハンドラー拡張
- [ ] **2.1.1** 個人入退室記録機能
  - **ファイル**: `backend/plugins/discord.ts`
  - **内容**: handleVoiceStateUpdate関数の拡張
  - **重要**: 既存のセッション管理との両立

- [ ] **2.1.2** 通話開始者フラグ記録
  - **ファイル**: `backend/plugins/discord.ts`
  - **内容**: isSessionStarter判定ロジック
  - **連携**: voice_sessionsとuser_voice_activitiesの連携

- [ ] **2.1.3** リアルタイム統計更新
  - **ファイル**: `backend/plugins/discord.ts`
  - **内容**: 退室時の統計自動更新
  - **パフォーマンス**: 週・月・年統計の効率的更新

### 2.2 統計計算ロジック
- [ ] **2.2.1** 期間キー生成関数
  - **ファイル**: `backend/utils/period.ts` (新規作成)
  - **内容**: 週・月・年キーの生成（日本時間基準）
  - **重要**: 日跨ぎ処理の正確性

- [ ] **2.2.2** ランキング計算関数
  - **ファイル**: `backend/utils/statistics.ts` (新規作成)
  - **内容**: 前期間比較付きランキング計算
  - **パフォーマンス**: 大量データでの高速処理

- [ ] **2.2.3** タイムライン生成関数
  - **ファイル**: `backend/utils/statistics.ts`
  - **内容**: 指定期間のセッション履歴整理
  - **複雑度**: 重複セッション・途中参加の処理

### 2.3 統一API基盤
- [ ] **2.3.1** APIレスポンス統一プラグイン
  - **ファイル**: `backend/plugins/response.ts` (新規作成)
  - **内容**: 統一レスポンス形式の生成
  - **機能**: data/meta/error の自動構造化

- [ ] **2.3.2** 権限チェックプラグイン
  - **ファイル**: `backend/plugins/permission.ts` (新規作成)
  - **内容**: VIEW/MANAGE/EXECUTE権限レベル実装
  - **セキュリティ**: 既存認証システムとの連携

- [ ] **2.3.3** エラーハンドリング統一
  - **ファイル**: `backend/plugins/response.ts`
  - **内容**: 構造化エラーレスポンス
  - **ユーザビリティ**: わかりやすいエラーメッセージ

### 2.4 統計API実装 ✅ **Phase 2.4 完了**
- [x] **2.4.1** ランキングAPI **✅ 実装完了**
  - **ファイル**: `backend/routes/api/v1/guilds/rankings.ts`
  - **エンドポイント**: `GET /api/v1/guilds/{guildId}/statistics/rankings`
  - **機能**: 柔軟な期間指定・メトリクス指定・前期間比較機能
  - **実装内容**: 
    - 完全なバリデーション（日付・メトリクス・権限）
    - 前期間比較機能（変化量・変化率・順位変動）
    - 統一APIレスポンス形式対応
    - Fastify AutoLoad対応

- [x] **2.4.2** タイムラインAPI **✅ 実装完了**
  - **ファイル**: `backend/routes/api/v1/guilds/timeline.ts`
  - **エンドポイント**: `GET /api/v1/guilds/{guildId}/statistics/timeline`
  - **機能**: 指定時間範囲での詳細セッション履歴
  - **実装内容**: 
    - 重複セッション・継続中セッション処理
    - Discord APIによるチャンネル名補完
    - 期間制限・パフォーマンス最適化
    - ユーザー別セッション集約

- [x] **2.4.3** サマリー履歴API **✅ 実装完了**
  - **ファイル**: `backend/routes/api/v1/guilds/summaries.ts`
  - **エンドポイント**: `GET /api/v1/guilds/{guildId}/statistics/summaries`
  - **機能**: 日次・週次・月次サマリーの履歴取得
  - **実装内容**: 
    - ページネーション（limit/offset）
    - 期間フィルタリング（from/to）
    - 通知状態管理・サマリー種別対応
    - 将来の通知システムとの連携準備

- [x] **2.4.4** 統計計算ユーティリティ **✅ 実装完了**
  - **ファイル**: `backend/utils/statistics.ts`, `backend/utils/validation.ts`
  - **機能**: 統計計算・バリデーション・データ処理
  - **実装内容**:
    - ランキング計算・前期間比較ロジック
    - タイムライン生成・重複処理
    - 包括的なバリデーション関数
    - 日付・期間計算ユーティリティ

**Phase 2.4 実装成果:**
- 3つの統計APIエンドポイント完全実装
- Fastify AutoLoad対応・ルート重複問題解決
- 統一APIレスポンス形式・構造化エラーハンドリング
- 権限チェック・認証統合
- 前期間比較・詳細統計機能
- 次フェーズ（フロントエンド統計ダッシュボード）への基盤完了

## Phase 3: フロントエンド統計画面

### 3.1 API通信基盤
- [ ] **3.1.1** 統一APIクライアント更新
  - **ファイル**: `frontend/src/utils/api.ts`
  - **内容**: 新API設計対応・統一レスポンス処理
  - **エラー処理**: 構造化エラーの適切な表示

- [ ] **3.1.2** 統計データフック作成
  - **ファイル**: `frontend/src/hooks/useStatistics.ts` (新規作成)
  - **内容**: ランキング・タイムライン取得カスタムフック
  - **キャッシュ**: データの効率的な管理

- [ ] **3.1.3** 期間選択フック作成
  - **ファイル**: `frontend/src/hooks/usePeriodSelector.ts` (新規作成)
  - **内容**: 週・月・年・カスタム期間の管理
  - **UX**: 直感的な期間選択

### 3.2 統計表示コンポーネント
- [ ] **3.2.1** ランキング表示コンポーネント
  - **ファイル**: `frontend/src/components/statistics/RankingTable.tsx` (新規作成)
  - **機能**: 順位・比較・変動表示
  - **デザイン**: 既存のモックデザインを基に実装

- [ ] **3.2.2** タイムライン表示コンポーネント  
  - **ファイル**: `frontend/src/components/statistics/Timeline.tsx` (新規作成)
  - **機能**: 横軸時間・縦軸ユーザーの視覚化
  - **インタラクティブ**: ホバー詳細・ズーム機能

- [ ] **3.2.3** 統計サマリーカード
  - **ファイル**: `frontend/src/components/statistics/StatsSummary.tsx` (新規作成)
  - **機能**: 総活動時間・参加者数等の概要表示
  - **レスポンシブ**: モバイル対応レイアウト

### 3.3 統計ダッシュボード画面
- [ ] **3.3.1** メイン統計ページ
  - **ファイル**: `frontend/src/pages/StatisticsPage.tsx` (新規作成)
  - **レイアウト**: 期間選択・ランキング・サマリーの統合
  - **ナビゲーション**: 既存ダッシュボードとの統合

- [ ] **3.3.2** タイムライン専用ページ
  - **ファイル**: `frontend/src/pages/TimelinePage.tsx` (新規作成)
  - **機能**: 日付選択・詳細タイムライン表示
  - **パフォーマンス**: 大量データの効率的表示

- [ ] **3.3.3** ナビゲーション更新
  - **ファイル**: `frontend/src/components/NeonDashboard.tsx`
  - **内容**: 統計メニューの追加
  - **統合**: 既存のタブ構造との整合性

### 3.4 手動更新機能
- [ ] **3.4.1** リフレッシュボタン実装
  - **ファイル**: 各統計コンポーネント
  - **機能**: データの手動再取得
  - **UX**: ローディング状態・成功通知

- [ ] **3.4.2** 自動更新設定
  - **ファイル**: `frontend/src/hooks/useAutoRefresh.ts` (新規作成)
  - **機能**: 設定可能な自動更新間隔
  - **パフォーマンス**: 非アクティブ時の更新停止

## Phase 4: 通知システム

### 4.1 スケジューラー基盤
- [ ] **4.1.1** Cronプラグイン作成
  - **ファイル**: `backend/plugins/scheduler.ts` (新規作成)
  - **内容**: node-cronによる定期実行システム
  - **安定性**: エラー時の自動復旧

- [ ] **4.1.2** 通知チェック機能
  - **ファイル**: `backend/utils/notifications.ts` (新規作成)
  - **内容**: 通知スケジュールのチェック・実行
  - **精度**: 日本時間での正確なタイミング制御

### 4.2 サマリー生成システム
- [ ] **4.2.1** 日次サマリー生成
  - **ファイル**: `backend/utils/summaries.ts` (新規作成)
  - **内容**: カスタム活動期間での統計集計
  - **パフォーマンス**: 大量データの効率的処理

- [ ] **4.2.2** 週次・月次サマリー生成
  - **ファイル**: `backend/utils/summaries.ts`
  - **内容**: 週間・月間統計の自動生成
  - **データ整合性**: 既存統計との一致確認

### 4.3 Discord通知機能
- [ ] **4.3.1** 通知メッセージ生成
  - **ファイル**: `backend/utils/discord-messages.ts` (新規作成)
  - **内容**: Embed形式での美しい通知作成
  - **デザイン**: 統一されたビジュアル

- [ ] **4.3.2** 通知送信システム
  - **ファイル**: `backend/utils/notifications.ts`
  - **内容**: Discord APIを使った自動通知送信
  - **エラー処理**: 送信失敗時のリトライ機能

### 4.4 通知設定API
- [ ] **4.4.1** スケジュール管理API
  - **ファイル**: `backend/routes/api/v1/guilds/[guildId]/notifications/schedules.ts` (新規作成)
  - **エンドポイント**: GET/PUT通知設定
  - **バリデーション**: 時刻・日付の適切な検証

- [ ] **4.4.2** テスト通知API
  - **ファイル**: `backend/routes/api/v1/guilds/[guildId]/notifications/test.ts` (新規作成)
  - **エンドポイント**: POST即座にテスト通知送信
  - **安全性**: テスト通知の適切な表示

### 4.5 通知設定Web UI
- [ ] **4.5.1** 通知設定画面
  - **ファイル**: `frontend/src/pages/NotificationSettingsPage.tsx` (新規作成)
  - **機能**: 時刻設定・活動期間設定・チャンネル選択
  - **UX**: 直感的な設定インターフェース

- [ ] **4.5.2** テスト通知機能
  - **ファイル**: `frontend/src/components/notifications/TestNotification.tsx` (新規作成)
  - **機能**: ワンクリックテスト送信
  - **フィードバック**: 送信結果の即座表示

## 実装時の注意事項

### データベースマイグレーション
```typescript
// 既存データを保持しながらテーブル追加
// 外部キー制約の段階的追加
// インデックス作成によるパフォーマンス影響の最小化
```

### 既存機能との整合性
```typescript
// 現在のvoice_sessions管理は維持
// 既存のDiscord認証システムを活用
// 現在のWeb UI構造に統合
```

### パフォーマンス考慮
```typescript
// 大量データでの統計計算最適化
// 適切なページング実装
// 必要最小限のデータ取得
```

### エラー処理
```typescript
// Discord API制限への対応
// データベース接続エラーの処理
// ユーザーフレンドリーなエラーメッセージ
```

## 完了基準

### Phase 1完了基準
- [ ] 全テーブルが正常に作成される
- [ ] 型定義エラーがない
- [ ] 基本的なCRUD操作が動作する

### Phase 2完了基準  
- [ ] Discord入退室が正確に記録される
- [ ] ランキングAPIが期待通りのデータを返す
- [ ] タイムラインAPIが正確な時系列データを返す

### Phase 3完了基準
- [ ] 統計ダッシュボードが表示される
- [ ] 期間切り替えが正常に動作する
- [ ] 手動更新が機能する

### Phase 4完了基準
- [ ] 設定した時刻に通知が送信される
- [ ] 通知内容が正確である
- [ ] 重複通知が発生しない

## トラブルシューティング用チェックリスト

### データベース関連
- [ ] テーブル作成SQL文の確認
- [ ] 外部キー制約の整合性
- [ ] インデックスの効果確認

### Discord API関連
- [ ] Bot権限の確認
- [ ] レート制限の対応
- [ ] WebhookとBotの使い分け

### フロントエンド関連
- [ ] API型定義の一致
- [ ] エラー状態の適切な表示
- [ ] レスポンシブデザインの確認